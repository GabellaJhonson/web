<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Селектор городов — пример</title>
<style>
  :root{
    --accent:#007aff;
    --bg:#fff;
    --pill-bg: rgba(0,122,255,0.12);
    --pill-border: rgba(0,0,0,0.08);
    --text:#111;
    font-family: Inter, Roboto, Arial, sans-serif;
  }
  body{ margin:20px; color:var(--text); background:#f6f7f9; }
  .selector {
    max-width:700px;
    margin:0 auto;
  }

  .controls {
    display:flex;
    gap:12px;
    align-items:center;
    margin-bottom:12px;
  }

  .btn {
    background:var(--accent);
    color:#fff;
    padding:10px 16px;
    border-radius:10px;
    border:0;
    cursor:pointer;
    font-weight:600;
  }

  .tags {
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .tag {
    display:inline-flex;
    gap:8px;
    align-items:center;
    padding:8px 12px;
    border-radius:20px;
    background:var(--pill-bg);
    border:1px solid var(--pill-border);
    font-size:14px;
  }
  .tag button{
    border:0;
    background:transparent;
    cursor:pointer;
    font-weight:700;
    padding:0;
  }

  /* Dropdown / panel */
  .panel-backdrop{
    position:fixed;
    inset:0;
    display:none;
    align-items:flex-start;
    justify-content:center;
    z-index:2000;
    background:rgba(0,0,0,0.25);
    padding:24px;
  }
  .panel {
    background:var(--bg);
    width:760px;
    max-width:100%;
    border-radius:12px;
    box-shadow:0 8px 30px rgba(0,0,0,0.15);
    overflow:hidden;
    display:flex;
    gap:0;
  }
  .panel .col {
    padding:18px;
  }
  .col.left {
    width:240px;
    border-right:1px solid #efefef;
  }
  .col.right {
    width:420px;
    max-width:calc(100% - 240px);
  }

  .region-item, .city-item {
    padding:10px 8px;
    cursor:pointer;
    border-radius:8px;
  }
  .region-item.active, .city-item.active { background:rgba(0,0,0,0.04); }
  .region-list, .city-list { max-height:460px; overflow:auto; padding:6px 0; }

  .search {
    margin-bottom:12px;
  }
  input[type="search"]{
    width:100%;
    padding:8px 12px;
    border-radius:8px;
    border:1px solid #e3e3e3;
  }

  .panel-footer {
    display:flex;
    gap:8px;
    padding:12px 18px;
    border-top:1px solid #eee;
    justify-content:flex-end;
    background:#fff;
  }
  .btn.ghost { background:transparent; color:var(--accent); border:1px solid var(--accent); padding:8px 12px; border-radius:8px; }

  /* mobile: show panel fullscreen */
  @media (max-width:600px){
    .panel-backdrop{ align-items:flex-end; padding:0; }
    .panel { width:100%; border-radius:12px 12px 0 0; }
    .col.left{ display:none; }
    .col.right { width:100%; max-width:100%; padding:12px 14px; }
    .panel-footer { position:sticky; bottom:0; background:#fff; }
  }

  /* small helpers */
  .muted { color:#666; font-size:13px; }
  .checkbox { margin-right:8px; }
  .select-all { font-size:13px; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
</style>
</head>
<body>
  <div class="selector" id="citySelector">
    <h3>Ваш регион</h3>
    <div class="controls">
      <button class="btn" id="openBtn">Добавить города</button>
      <div class="tags" id="selectedTags"></div>
    </div>
    <p class="muted">Выбранные города/области отобразятся как теги.</p>
  </div>

  <!-- Панель выбора -->
  <div class="panel-backdrop" id="backdrop" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true" aria-label="Выберите города">
      <!-- Левый столбец: Области -->
      <div class="col left">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <strong>Области</strong>
          <button id="closeLeft" title="Закрыть" style="border:0;background:transparent;cursor:pointer;font-size:18px">✕</button>
        </div>
        <div class="region-list" id="regionList"></div>
      </div>

      <!-- Правый столбец: Города и фильтры -->
      <div class="col right">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <strong id="rightTitle">Вся Беларусь</strong>
          <div class="muted" id="countText">0 выбранных</div>
        </div>

        <div class="search" style="margin-top:12px;">
          <input type="search" id="citySearch" placeholder="Поиск по городам..." />
        </div>

        <div class="select-all" id="selectAllRow" style="display:none;">
          <label><input type="checkbox" id="selectAll" class="checkbox"> Выбрать всё в области</label>
        </div>

        <div class="city-list" id="cityList" style="margin-top:8px;"></div>

        <div class="panel-footer">
          <button class="btn ghost" id="clearBtn">Очистить</button>
          <button class="btn" id="doneBtn">Готово</button>
        </div>
      </div>

    </div>
  </div>

<script>
/*
  Примерный DATA — расширяйте по необходимости.
  Формат:
  {
    id: 'minskaya',
    name: 'Минская',
    cities: ['Минский район','Борисов', 'Жодино', ...]
  }
*/
const DATA = [
  { id:'all', name:'Вся Беларусь', cities: [] },
  { id:'minsk', name:'Минск', cities: ['Все районы','Центральный','Советский','Первомайский','Партизанский','Заводской','Ленинский','Октябрьский','Московский','Фрунзенский'] },
  { id:'minskaya', name:'Минская', cities: ['Минский район','Березино','Борисов','Боровляны','Вилейка','Воложин','Городея','Дзержинск','Жодино','Заславль','Зеленый Бор','Ивенец','Клецк','Копыль','Крупки','Логойск','Любань','Марьина Горка'] },
  { id:'brest', name:'Брестская', cities: ['Брест','Пинск','Кобрин'] },
  { id:'gomel', name:'Гомельская', cities: ['Гомель','Речица','Жлобин'] },
  { id:'grodno', name:'Гродненская', cities: ['Гродно','Слоним','Волковыск'] },
  { id:'vitebsk', name:'Витебская', cities: ['Витебск','Орша','Полоцк'] },
  { id:'mogilev', name:'Могилевская', cities: ['Могилев','Бобруйск'] }
];

(function(){
  // State
  const selected = new Map(); // key: 'region' or 'region:city' -> true
  let activeRegionId = 'all'; // which region's cities shown on right
  const openBtn = document.getElementById('openBtn');
  const backdrop = document.getElementById('backdrop');
  const regionList = document.getElementById('regionList');
  const cityList = document.getElementById('cityList');
  const rightTitle = document.getElementById('rightTitle');
  const countText = document.getElementById('countText');
  const selectedTags = document.getElementById('selectedTags');
  const citySearch = document.getElementById('citySearch');
  const selectAllRow = document.getElementById('selectAllRow');
  const selectAllCheckbox = document.getElementById('selectAll');
  const clearBtn = document.getElementById('clearBtn');
  const doneBtn = document.getElementById('doneBtn');
  const closeLeft = document.getElementById('closeLeft');

  // init render
  function renderRegions() {
    regionList.innerHTML = '';
    DATA.forEach(region=>{
      const div = document.createElement('div');
      div.className = 'region-item' + (region.id===activeRegionId ? ' active':'');
      div.tabIndex = 0;
      div.dataset.id = region.id;
      div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;">
        <span>${region.name}</span>
        <small class="muted">${region.cities.length ? region.cities.length : ''}</small>
      </div>`;
      div.addEventListener('click', ()=> {
        activeRegionId = region.id;
        citySearch.value = '';
        renderRegions();
        renderCities();
      });
      regionList.appendChild(div);
    });
  }

  function getRegionById(id){ return DATA.find(r=>r.id===id); }

  function renderCities() {
    const region = getRegionById(activeRegionId) || DATA[0];
    rightTitle.textContent = region.name;
    // show select-all only when region has cities
    if (region.cities && region.cities.length) {
      selectAllRow.style.display = 'block';
      // set selectAllCheckbox according to whether all cities selected
      const allSel = region.cities.every(city => selected.has(region.id + ':' + city));
      selectAllCheckbox.checked = allSel;
    } else {
      selectAllRow.style.display = 'none';
    }

    // filter by search
    const q = citySearch.value.trim().toLowerCase();
    cityList.innerHTML = '';
    if (!region.cities || !region.cities.length) {
      cityList.innerHTML = '<div class="muted">Нет городов для выбора</div>';
      updateCount();
      return;
    }
    region.cities.forEach(city=>{
      if (q && !city.toLowerCase().includes(q)) return;
      const key = region.id + ':' + city;
      const isChecked = selected.has(key);
      const item = document.createElement('label');
      item.className = 'city-item' + (isChecked ? ' active' : '');
      item.style.display = 'flex';
      item.style.alignItems = 'center';
      item.style.gap = '8px';
      item.innerHTML = `<input type="checkbox" class="checkbox city-checkbox" data-key="${key}" ${isChecked?'checked':''}>
                        <span>${city}</span>`;
      item.querySelector('input').addEventListener('change', (e)=>{
        const checked = e.target.checked;
        if (checked) selected.set(key, true);
        else selected.delete(key);
        updateTags();
        renderCities();
      });
      cityList.appendChild(item);
    });
    updateCount();
  }

  function updateCount(){
    const total = Array.from(selected.keys()).filter(k=>k.includes(':')).length;
    countText.textContent = `${total} выбранных`;
  }

  function updateTags(){
    selectedTags.innerHTML = '';
    // First, if whole region selected (we treat that as selecting all cities)
    // We'll show tags per city — but if you prefer to compact to "Минская (все)" we can adjust.
    const byRegion = {};
    selected.forEach((v,k)=>{
      if (k.includes(':')) {
        const [rid, city] = k.split(':');
        byRegion[rid] = byRegion[rid] || [];
        byRegion[rid].push(city);
      } else {
        byRegion[k] = byRegion[k] || [];
      }
    });

    // If user selected "all" (Вся Беларусь) and we want to display single tag:
    if (selected.has('all')) {
      const pill = createTag('Вся Беларусь', ()=> {
        // remove all
        selected.clear();
        updateTags();
        renderCities();
        renderRegions();
      });
      selectedTags.appendChild(pill);
      return;
    }

    // render region tags (grouped)
    Object.keys(byRegion).forEach(rid=>{
      const region = getRegionById(rid);
      const arr = byRegion[rid];
      if (!region) return;
      // If all cities of region selected -> show single region tag
      if (region.cities.length && arr.length === region.cities.length) {
        const pill = createTag(region.name, ()=> {
          // remove region selection (all cities)
          region.cities.forEach(c=> selected.delete(rid+':'+c));
          updateTags(); renderCities(); renderRegions();
        });
        selectedTags.appendChild(pill);
      } else {
        // otherwise show individual city tags
        arr.forEach(city=>{
          const pill = createTag(city, ()=> {
            selected.delete(rid+':'+city);
            updateTags(); renderCities(); renderRegions();
          });
          selectedTags.appendChild(pill);
        });
      }
    });

    updateCount();
  }

  function createTag(text, onDelete){
    const d = document.createElement('span');
    d.className = 'tag';
    d.innerHTML = `<span>${text}</span>`;
    const btn = document.createElement('button');
    btn.type='button';
    btn.textContent = '✕';
    btn.title='Удалить';
    btn.addEventListener('click', (e)=>{ e.stopPropagation(); onDelete(); });
    d.appendChild(btn);
    return d;
  }

  // control handlers
  openBtn.addEventListener('click', ()=> {
    backdrop.style.display = 'flex';
    backdrop.setAttribute('aria-hidden','false');
    // focus search
    setTimeout(()=> citySearch.focus(), 200);
    renderRegions();
    renderCities();
  });
  backdrop.addEventListener('click', (e)=> {
    if (e.target === backdrop) closePanel();
  });
  closeLeft.addEventListener('click', closePanel);
  doneBtn.addEventListener('click', closePanel);

  function closePanel(){
    backdrop.style.display = 'none';
    backdrop.setAttribute('aria-hidden','true');
  }

  // clear button -> clear all selections
  clearBtn.addEventListener('click', ()=>{
    selected.clear();
    updateTags();
    renderCities();
    renderRegions();
  });

  // select-all in region
  selectAllCheckbox.addEventListener('change', (e)=>{
    const checked = e.target.checked;
    const region = getRegionById(activeRegionId);
    if (!region || !region.cities) return;
    region.cities.forEach(city=>{
      const key = region.id + ':' + city;
      if (checked) selected.set(key,true);
      else selected.delete(key);
    });
    updateTags();
    renderCities();
    renderRegions();
  });

  // search
  citySearch.addEventListener('input', ()=> {
    renderCities();
  });

  // support selecting a region as "Вся Беларусь"
  // double-click or click special region 'Вся Беларусь' will set all cities for all regions
  // For convenience: clicking region in left already switches active region.
  regionList.addEventListener('dblclick', (e)=>{
    const el = e.target.closest('[data-id]');
    if (!el) return;
    const id = el.dataset.id;
    if (id === 'all') {
      // select all
      DATA.forEach(region=>{
        region.cities.forEach(city=> selected.set(region.id+':'+city,true));
      });
      selected.set('all', true);
      updateTags();
    }
  });

  // prevent losing state on reload in this demo — (optional) use localStorage
  // initial render
  renderRegions();
  renderCities();
  updateTags();

  // Accessibility: keyboard close (Esc)
  window.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') closePanel();
  });

})();
</script>
</body>
</html>
